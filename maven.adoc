= Travaux pratiques - Build et Maven
Nicolas Frankel
:doctype: article
:encoding: utf-8
:lang: fr
:toc:
:toc-placement!:
:numbered:
:experimental:
:sectanchors:
:icons: font
:imagesdir: images/maven

image::https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png[Licence Creative Commons, link="http://creativecommons.org/licenses/by-nc-sa/4.0/"]

Ce cours est mis à disposition selon les termes de la http://creativecommons.org/licenses/by-nc-sa/4.0/[Licence Creative Commons Attribution - Pas d’Utilisation Commerciale - Partage dans les Mêmes Conditions 4.0 International].

toc::[]

== Objectif

L'objectif de cette fiche est de porter un projet sous Maven pour automatiser le processus de _build_.

== Références

* https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html#Lifecycle_Reference[Lifecycle Reference]
* http://maven-guide-fr.erwan-alliaume.com/maven-guide-fr/site/reference/public-book.html[Maven, le guide final]

== Installation de Maven

Avant d'utiliser Maven, il est d'abord nécessaire de le mettre à disposition sur la machine locale.

En fonction du système d'exploitation, les méthodes d'installation de Maven sont différentes mais il existe une méthode commune :

1. https://maven.apache.org/download.cgi[Télécharger] le zip de Maven
1. Décompresser celui-ci dans le dossier standard des applications pour le système d'exploitation
+
[NOTE]
====
Pour Window, il est fortement conseillé que le chemin ne comporte pas d'espaces.
====
1. Si ce n'est pas le cas, ajouter une variable d'environnement `JAVA_HOME` et la faire pointer vers le répertoire d'installation de Java
1. Ajouter le chemin de vers le répertoire d'installation de Maven à la variable d'environnement `PATH`

Une fois ces étapes réalisées, il est possible d'invoquer Maven depuis n'importe quel chemin du système de fichiers avec la commande `mvn` _p.e._ `mvn compile`. 

== Premier pas

Cette section permet de migrer son projet pour le rendre compatible avec le standard Maven.

La première étape consiste à répartir les sources du projet existant dans la structure Maven standard:

* `src/main/java` pour le code Java "de production" qui doit être compilé
* `src/main/resources` pour les autres fichiers "de production"
* `src/test/java` pour le code Java de test
* `src/test/resources` pour les autres fichiers de test

La second étape consiste à créer un fichier _Project Object Model_ nommé `pom.xml` et situé à la racine du projet.

Le squelette du `pom.xml` doit avoir la structure suivante:

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
   <modelVersion>4.0.0</modelVersion>
   <groupId>ch.hesge.integrationcontinue</groupId>
   <artifactId>monprojet</artifactId>
   <version>0.0.1-SNAPSHOT</version>
</project>
----

Il est bien sûr nécessaire de modifier les informations de `groupId` et d'`artifactId` pour être spécifiques à votre projet.

== Configurer le proxy

Dans la plupart des cas, la station de travail (ou le serveur) ne peuvent pas accéder à Internet directement mais uniquement via l'utilisation d'un serveur proxy.

Pour ce faire, il est nécessaire de créer un fichier `settings.xml` dans votre _home_.

[NOTE]
====
Le _home_ dépend du type et de la version du système d'exploitation. Il peut être recherché sur le web, ou bien récupéré depuis la propriété Java `user.home` :
[source,java]
----
System.getProperty("user.home");
----
====

Le fichier de _settings_ doit reproduire le modèle suivant :

[source,java]
----
<settings xmlns="http://maven.apache.org/SETTINGS/1.1.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.1.0
    http://maven.apache.org/xsd/settings-1.1.0.xsd">
  <proxies>
    <proxy>
      <id>heg</id>
      <active>true</active>
      <protocol>http</protocol>
      <username>identifiant</username>
      <password>motdepasse</password>
      <port>proxyhes.etat-ge.ch</port>
      <host>80</host>
    </proxy>
  </proxies>
</settings>
----

Si tout a été correctement réalisé, il est maintenant possible de construire votre projet à l'aide de la commande `mvn package`.

Vérifier l'existence d'un JAR dans le répertoire `target` à la racine du projet.

== Gérer les plugins

=== Configurer un plugin

Cette section a pour objectif d'expérimenter avec la configuration des plugins afin de rendre son _jar_ exécutable. Un tel jar peut être lancé via la commande suivante (ou en double-cliquant dessus pour les systèmes graphiques) :

[source, bash]
----
java -jar monjar.jar
----

Pour parvenir à ce résultat, un _jar_ doit remplir deux conditions :

* Disposer d'un fichier de manifeste standard `META-INF/MANIFEST.MF` dont une entrée référence une classe spécifique :
+
[source]
----
Main-Class: ch.hesge.monprojet.MaClasse
----

* Cette classe référencée doit contenir une méthode dont la signature est exactement `public static void main(String... args)`. Cette méthode est le point d'entrée du _jar_ et sera exécutée lors du lancement.

La création du manifeste rentre exactement dans le cadre du processus d'automatisation de la construction. Le plugin considéré est le Maven JAR plugin. A l'aide de la  https://maven.apache.org/shared/maven-archiver/examples/classpath.html#Make[documentation], configurer votre projet pour rendre le JAR exécutable.

[NOTE]
====
Toujours spécifier *explicitement* la version des plugins utilisés. Si aucune version n'est indiquée, Maven utilisera la dernière version disponible et celle-ci pourra donc changer au cours du cycle de vie du projet. Une version différente peut engendrer des différences de comportement et représente donc un risque important pour la stabilité du _build_.
====

=== Lier un nouveau plugin

Le plugin https://github.com/ktoso/maven-git-commit-id-plugin[git-commit-id-plugin] permet de créer un fichier contenant des informations sur l'état du dépôt Git local.

Lire attentivement la documentation du plugin puis faire en sorte que chaque exécution `mvn prepare-package` crée un fichier `git.properties` contenant les informations demandées à la racine du répertoire `target/classes`.

== Gérer les dépendances

Cette section a pour objectif d'apprendre à manipuler la configuration des dépendances.

=== Ajouter une dépendance simple

Consulter la https://github.com/akullpp/awesome-java[liste] des librairies Java utiles. L'utiliser dans votre projet en concertation avec l'enseignant. Par exemple :

* Gérer les dates avec http://www.joda.org/joda-time[joda-time]
* Utiliser une des nombreuses fonctionnalités de https://github.com/google/guava[Guava]
* Offrir une interface REST très simple avec http://sparkjava.com/[Spark]
* etc.

=== Ajouter les dépendances de test

Pour préparer le cours suivant, ajouter la dépendance envers la dernière version de http://testng.org/[TestNG]. Les coordonnées Maven de cette librairie sont `org.testng:testng`.

[WARNING]
====
Ne pas oublier de configurer la porté adaptée.
====

Ajouter également les dépendances envers http://mockito.org/[Mockito] et https://joel-costigliola.github.io/assertj/[AssertJ] avec la même portée.

=== Ajouter une dépendance à l'exécution

Il existe une grande quantité de librairies de logs dans l'écosystème Java _p.e._ https://commons.apache.org/proper/commons-logging[Apache Commons Logging], https://logging.apache.org/log4j[Log4J] sans oublier le package `java.util.logging` du JDK.

Parmi toutes ces options, la solution http://www.slf4j.org[SLF4J] est particulièrement intéressante car elle offre une séparation claire entre l'API et les différentes implémentations disponibles.

image::http://www.slf4j.org/images/concrete-bindings.png[Principe de fonctionnement]

1. Ajouter l'API SLF4J - `org.slf4j:slf4j-api`, comme dépendance simple
1. Ajouter quelques logs à l'application, _p.e._ :
+
[source, java]
----
Logger logger = LoggerFactory.getLogger(MaClass.class);
logger.info("Ecrire quelque chose d'utile");
----
+
1. Ajouter l'implémentation `org.slf4j:slf4j-simple` comme dépendance à l'exécution
1. Exécuter l'application soit dans l'IDE, soit via l'exéuction du JAR packagé
1. Vérifier le résultat dans la console pendant l'exécution

[TIP]
====
Les versions de l'API et de l'implémentation doivent être les mêmes. Pour cela, il est conseillé d'utiliser la balise `properties` du POM.
====

== Déployer un artéfact

Afin de mettre son artéfact à disposition, il est nécessaire de le déployer sur un dépôt distant, soit public, soit privé. Cette section sera dédiée à cela.

Dans le cadre de ces travaux pratiques, le dépôt choisi sera https://bintray.com/[Bintray]. Bintray est un dépôt Maven (mais accepte également d'autres types d'artéfacts) https://www.jfrog.com/open-source/[Artifactory] dans le _cloud_. L'utilisation gratuite offre la possibilité de déployer des artéfacts Maven sur un dépôt public.

[NOTE]
====
Bintray offre également une souscription payante qui permet de disposer de dépôts privés dans le _cloud_.
====

=== Créer un compte Bintray

Se rendre sur le site de https://bintray.com/[Bintray].

image::bintray.png[Accueil]

Cliquer sur le bouton btn:[Get Started for Free].

image::signinup.png[Authentification]

Cliquer maintenant sur le bouton btn:[Sign Up]

image::registration.png[Enregistrement]

Il est possible de créer un compte dédié, mais il est plus pratique d'utiliser l'identification de son compte Github. Cliquer sur l'icône Github en bas de la fenêtre. Vous êtes alors redirigés vers Github.

image::modifyauth.png[Permission Bintray]

Cliquer sur le bouton btn:[Authorize application]

Vous êtes finalement redirigés sur Bintray et êtes maintenant automatiquement authentifiés comme le montre la barre de menu.

image::authentified.png[Authentifié]

=== Créer le package sur Bintray

La seconde étape préalable au déploiement d'artéfacts sur Bintray est de créer un _package_, c'est-à-dire un emplacement pour le projet Maven désiré.

Naviguer vers la page d'accueil.

image::repositories.png[Liste des dépôts]

Cliquer sur le dépôt Maven. La liste des _packages_ Maven existants s'affiche.

image::mvnrepo.png[Liste des packages]

Cliquer sur le bouton btn:[Add New Package] en bas à droite.

image::createpackage.png[Création d'un package]

Renseigner les informations obligatoires suivantes :

* Le nom du package. Il est vivement conseillé d'utiliser l' `artifactId` du projet Maven pour des raisons de référencement.
* Le type de license. Par défaut, choisir Apache-2.0.
* L'URL du dépôt de source. Indiquer l'URL du dépôt Github correspondant.

Finaliser la création en cliquant sur le bouton btn:[Create Package]. La page de détail du _package_ s'affiche avec un message d'information qui indique que l'opération s'est déroulée avec succès.

=== Configurer le dépôt de déploiement pour le projet Maven

Il est maintenant nécessaire d'ajouter la section `distributionManagement` au projet Maven afin d'indiquer sur quel dépôt d'artéfacts déployer l'artéfact final.

Voici un exemple d'une telle section pour Bintray.

[source,xml]
----
<project...>
  <distributionManagement>
    <repository>
      <id>bintray</id>
      <url>https://api.bintray.com/maven/{BINTRAY_USER}/{BINTRAY_PACKAGE}</url>
    </repository>
  </distributionManagement>
</project>
----
`{BINTRAY_USER}`::
Nom d'utilisateur Bintray _p.e_ nfrankel
`{BINTRAY_PACKAGE}`::
Nom du _package_ Bintray, c'est-à-dire le libellé utilisé lors de la link:http://localhost:60141/afx/resource/Users/i303869/projects/course/integrationcontinue/preview.html#truecr_er_le_package_sur_bintray[création]

=== Configurer l'authentification pour le déploiement

Avant de pouvoir déployer sur Bintray, il est nécessaire de s'authentifier. En effet, il n'est pas permis à n'importe qui de déployer ses artifacts sur les dépôts d'un utilisateur.

Connaître sa clé d'API::
L'authentification pour la publication d'artéfacts sur Bintray est basé sur le couple nom d'utilisateur Bintray/clé d'API. Afin de connaître cette dernière, survoler votre nom de profil en haut à droite. Un menu déroulant apparaît.
+
image::scrollingmenu.png[Menu de profil]
+
Cliquer sur le premier élément de menu libellé btn:[Your Profile].
+
image::profile.png[Profil]
+
Cliquer sur le bouton btn:[Edit]
+
image::profilemenu.png[Menu d'édition de profil]
+
Puis, dans le menu droit, cliquer sur le dernier élément de menu libellé btn:[API Key].
+
image::apikey.png[API Key]
+
Enfin, pour afficher la clé d'API, cliquer sur le bouton btn:[Show].
+
Utiliser sa clé d'API::
Dans votre répertoire `$HOME/.m2`, créer un fichier `settings.xml`. Ce fichier respecte un format standard décrit dans la https://maven.apache.org/settings.html:[documentation Maven].
+
Votre fichier doit ressembler à l'extrait suivant :
+
[source, xml]
----
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
  <servers>
    <server>
      <id>bintray</id>
      <username>nfrankel</username>
      <password>{API_KEY}</password>
    </server>
  </servers>
</settings>
----

== Afficher la version de l'application

Afin d'afficher la version dans une application graphique (client lourd ou client web), les étapes suivantes sont nécessaires :

1. Activer le filtrage Maven
1. Créer un fichier de _properties_ à la racine du répertoire de ressources, _p.e._ `application.properties`
1. Créer une propriété avec une clé définie, _p.e._ `application.version`
1. Lui affecter une valeur de telle sorte que le filtrage Maven la remplace par la version de l'application pendant le build
1. Développer une fonctionnalité de l'application pour lire cette valeur. Voici un exemple d'un tel code :
+
[source,java]
----
try (InputStream stream = new FileInputStream("application.properties")) {
    properties.load(stream);
    String version = properties.getProperty("application.version");
} catch (Exception e) {
    // Do something meaningful here
}
----
1. Finalement, afficher cette valeur à l'écran

[NOTE]
====
L'approche naïve pour afficher la version de l'application est de https://maven.apache.org/shared/maven-archiver/examples/manifest.html[configurer] l'_archiver_ du Maven JAR plugin pour écrire celle-ci comme valeur de la clé `Implementation-Version` du fichier de manifeste. Toutefois, dès lors qu'il existe plus d'un unique JAR dans le _classpath_ (_p.e._ lorsqu'on utilise des librairies tierces), les limitations inhérentes du _classloader_ se manifestent (_cf._ https://stackoverflow.com/questions/1272648/reading-my-own-jars-manifest[StackOverflow]).
====

== Effectuer une release

Utiliser le https://maven.apache.org/maven-release/maven-release-plugin/[Maven release plugin] pour effectuer une release de votre projet sur Bintray.

Pour cela, la section `scm` doit être renseignée. Voici un exemple d'une telle section :

[source, xml]
----
<scm>
  <url>https://github.com/nfrankel/refactoring-example</url>
  <connection>scm:git:git@github.com:nfrankel/refactoring-example.git</connection>
  <developerConnection>scm:git:git@github.com:nfrankel/refactoring-example.git</developerConnection>
</scm>
----
Pour plus d'information, consulter la https://maven.apache.org/pom.html#SCM[documentation Maven afférente].

Lancer successivement les commandes `mvn release:prepare` et `mvn release:perform`.

Vérifier le succès de l'opération :

* Le package Bintray a été créé
* Le dépôt Github montre qu'un tag a été posé et le POM montre que la version a été modifiée